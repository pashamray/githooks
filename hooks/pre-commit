#!/usr/bin/env bash
# Pre-commit hook script
# Runs code quality checks before committing

set -e

# Get the directory where this script is located (following symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
# Get the root directory of githooks project
GITHOOKS_ROOT="$(dirname "$SCRIPT_DIR")"

echo "Pre-commit hook starting..."
echo "Working directory: $(pwd)"
echo "Githooks root: $GITHOOKS_ROOT"

# Run PHP code style fixer
if [ -f "$GITHOOKS_ROOT/scripts/run-phpcbf.sh" ]; then
    "$GITHOOKS_ROOT/scripts/run-phpcbf.sh"
else
    echo "Warning: phpcbf script not found at $GITHOOKS_ROOT/scripts/run-phpcbf.sh"
fi

# Run Rector for PHP refactoring
if [ -f "$GITHOOKS_ROOT/scripts/run-rector.sh" ]; then
    "$GITHOOKS_ROOT/scripts/run-rector.sh"
else
    echo "Warning: rector script not found at $GITHOOKS_ROOT/scripts/run-rector.sh"
fi

# Check if there are still files staged for commit
STAGED_FILES=$(git diff --cached --name-only)
if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit after running checks. Aborting commit."
    exit 1
fi

echo "Pre-commit checks completed successfully."
